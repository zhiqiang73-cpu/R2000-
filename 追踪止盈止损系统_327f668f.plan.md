---
name: 追踪止盈止损系统
overview: 在回测器和模拟交易中实现追踪止盈止损系统，包括：+6%止损上移、时间衰减止损、TP1后动态追踪止损（最高价-8%）、移除TP2上限。
todos:
  - id: config-params
    content: 在 config.py 添加追踪止损相关配置参数
    status: completed
  - id: backtester-position
    content: 修改 backtester.py 的 Position 数据结构，添加追踪字段
    status: completed
  - id: backtester-open
    content: 修改 _open_position() 移除 TP2，保存 original_stop_loss
    status: completed
  - id: backtester-exit
    content: 重写 _check_exit() 实现阶梯止损上移、时间衰减、追踪止损
    status: completed
  - id: backtester-loop
    content: 修改主循环，每根K线更新 peak_pnl_pct
    status: completed
  - id: binance-next-stage
    content: 修改 _place_next_stage_orders() 移除 TP2，只挂保本SL
    status: completed
  - id: binance-trailing
    content: 新增 _update_trailing_stop() 动态更新追踪止损
    status: completed
  - id: live-engine
    content: 修改 _process_holding() 添加止损上移和时间衰减逻辑
    status: completed
isProject: false
---

# 追踪止盈止损系统实现计划

## 一、新增配置参数

在 [config.py](config.py) 的 `PAPER_TRADING_CONFIG` 中添加：

```python
# 追踪止盈止损系统
"TRAILING_STOP_ENABLED": True,           # 启用追踪止损
"TRAILING_STOP_PCT": 0.08,               # 追踪止损间距 8%（价格）

# 阶梯止损上移
"BREAKEVEN_THRESHOLD_PCT": 6.0,          # 第一档阈值：浮盈+6%（杠杆后）
"BREAKEVEN_SL_PCT": -3.0,                # 第一档止损：-3%（杠杆后）

# 时间衰减止损
"TIME_DECAY_ENABLED": True,              # 启用时间衰减
"TIME_DECAY_BAR_1": 120,                 # 第一档：120根K线
"TIME_DECAY_SL_1": -10.0,                # 第一档止损：-10%（杠杆后）
"TIME_DECAY_BAR_2": 180,                 # 第二档：180根K线
"TIME_DECAY_SL_2": -5.0,                 # 第二档止损：-5%（杠杆后）
```

---

## 二、回测器修改

### 2.1 Position 数据结构 ([core/backtester.py](core/backtester.py) 24-37行)

新增字段：

```python
peak_pnl_pct: float = 0.0           # 追踪最高浮盈（杠杆后%）
ever_reached_6pct: bool = False     # 是否曾到达+6%（时间衰减判断用）
original_stop_loss: float = 0.0     # 原始止损价格（用于追踪止损计算）
```

### 2.2 _open_position() 修改 (430-473行)

- 移除 `take_profit_2` 的设置（不再需要TP2）
- 保存 `original_stop_loss`

### 2.3 _check_exit() 重写 (544-595行)

新逻辑：

```
阶段1 (stage=1)：入场 → TP1
├─ 计算当前浮盈 pnl_pct
├─ 更新 peak_pnl_pct = max(peak_pnl_pct, pnl_pct)
├─ 止损动态调整：
│   ├─ 若 peak_pnl_pct >= 6% 且未标记 → 止损上移到 -3%，标记 ever_reached_6pct
│   ├─ 若 未到过6% 且 持仓>120根 → 止损收窄到 -10%
│   └─ 若 未到过6% 且 持仓>180根 → 止损收窄到 -5%
├─ 检查SL触发 → 全平
└─ 检查TP1触发 (+12%) → 部分平仓70%，止损移到0%，进入阶段2

阶段2 (stage=2)：TP1后，剩余30%
├─ 追踪止损 = 最高价格 × (1 - 8%)  [LONG]
│            = 最高价格 × (1 + 8%)  [SHORT]
├─ 止损只升不降
├─ 检查追踪止损触发 → 全平剩余
└─ 无TP2上限，让利润奔跑
```

### 2.4 主循环修改 (run_with_strategy 378-422行)

每根K线需要：

1. 计算当前浮盈并更新 `peak_pnl_pct`
2. 将 current_idx 传递给 `_check_exit()` 用于计算持仓时间

---

## 三、模拟交易修改

### 3.1 PaperOrder 数据结构 ([core/paper_trader.py](core/paper_trader.py))

确认已有字段（无需新增）：

- `peak_profit_pct` (218行)
- `original_stop_loss` (待确认)

### 3.2 binance_testnet_trader.py 修改

#### _place_exchange_tp_sl() (1046-1133行)

- 保持不变：开仓时挂 TP1 + SL

#### _place_next_stage_orders() (1370-1459行)

核心修改：

- TP1成交后，**不再挂TP2**
- 只挂保本SL（入场价）
- 后续由 `_update_trailing_stop()` 动态追踪

#### 新增 _update_trailing_stop()

```python
def _update_trailing_stop(self, current_price: float) -> None:
    """动态更新追踪止损（TP1后启用）"""
    # 计算新止损价格 = 最高价 × (1 - 8%)
    # 若新止损 > 当前止损，则更新交易所止损单
```

### 3.3 live_trading_engine.py 修改

#### _process_holding() (3839-3985行)

添加逻辑：

1. 检查浮盈是否达到+6% → 止损上移到-3%
2. 检查时间衰减条件 → 调整止损
3. TP1后启动追踪止损

---

## 四、逻辑流程图

```mermaid
flowchart TD
    Entry[入场] --> Stage1[阶段1: 100%仓位]
    Stage1 --> CheckPnL{检查浮盈}
    
    CheckPnL -->|>= +6%| MoveSL1[止损上移到 -3%]
    MoveSL1 --> CheckTP1{浮盈 >= +12%?}
    
    CheckPnL -->|< +6%| CheckTime{持仓时间}
    CheckTime -->|> 180根| MoveSL180[止损收窄到 -5%]
    CheckTime -->|> 120根| MoveSL120[止损收窄到 -10%]
    CheckTime -->|<= 120根| CheckSL1{检查SL触发}
    MoveSL120 --> CheckSL1
    MoveSL180 --> CheckSL1
    
    CheckSL1 -->|触发| FullClose[全平仓]
    CheckSL1 -->|未触发| CheckTP1
    
    CheckTP1 -->|是| TP1Action[平仓70%, 止损移到0%]
    CheckTP1 -->|否| NextBar[下一根K线]
    NextBar --> CheckPnL
    
    TP1Action --> Stage2[阶段2: 30%仓位]
    Stage2 --> TrailingSL[追踪止损: 最高价-8%]
    TrailingSL --> CheckTrail{追踪止损触发?}
    CheckTrail -->|是| CloseRemain[平剩余30%]
    CheckTrail -->|否| UpdatePeak[更新最高价]
    UpdatePeak --> TrailingSL
    
    FullClose --> EndTrade[交易结束]
    CloseRemain --> EndTrade
```



---

## 五、测试验证

1. 回测验证：运行历史数据回测，对比新旧方案的：
  - 胜率
  - 平均盈亏
  - 最大回撤
  - 时间衰减触发次数
2. 模拟交易验证：
  - 检查止损单更新是否正常
  - 检查追踪止损是否正确跟随最高价

