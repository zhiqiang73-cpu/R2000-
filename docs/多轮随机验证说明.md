# WF Evolution 多轮随机验证方案

## 问题背景

**单轮进化的风险**：
- 固定使用最新 300K bars 进化
- 权重可能过拟合到这段时间的特殊市场特性
- 无法验证权重在其他时间段的泛化能力

## 解决方案：多轮随机验证

### 核心思路

**分阶段进化 + 交叉验证**：
1. **快速预筛**：从 5 个随机时间段中筛选出 2 个最有代表性的
2. **正式进化**：在 2 个时间段上各自独立进化（每段 18 trials）
3. **最终精炼**：选择最优轮，再投入 25 trials 精细优化
4. **交叉验证**：每轮最优权重在其他轮数据上验证
5. **权重集成**：可选按性能加权平均多轮最优权重

### 时间成本控制

| 模式 | 配置 | 时间 | 增加 |
|------|------|------|------|
| **单轮模式** | 60 trials × 3 folds | ~9分钟 | 基准 |
| **多轮模式（当前）** | 预筛+2轮+精炼+交叉验证 | ~13分钟 | +48% ✅ |
| **保守模式** | 3轮完整进化 | ~17分钟 | +89% |

### 详细流程

```
阶段1: 快速预筛 (~4分钟)
├─ 随机选择 5 个 300K 时间段
├─ 每段用 100K bars + 8 trials 快速评估
└─ 选择 Sharpe 最高的 2 段进入正式进化

阶段2: 正式进化 (~5分钟)
├─ 第1轮: 时间段A, 18 trials × 3 folds
│   └─ 保留 Top-2 权重组合
├─ 第2轮: 时间段B, 18 trials × 3 folds
│   └─ 保留 Top-2 权重组合
└─ (如果启用第3轮，在时间段C重复)

阶段3: 最终精炼 (~4分钟)
├─ 选择表现最好的轮次（比如第2轮）
└─ 在该时间段上追加 25 trials 精细优化

阶段4: 交叉验证 (~0.2分钟)
├─ 第1轮最优权重在第2轮数据上测试
├─ 第2轮最优权重在第1轮数据上测试
└─ 计算平均表现，选择泛化能力最强的权重

阶段5: 权重集成 (可选)
└─ 按各轮性能加权平均最优权重
```

## 关键配置参数

### 基础配置

```python
"MULTI_ROUND_ENABLED": True,         # 启用多轮验证
"EVOLUTION_ROUNDS": 2,               # 进化轮数（2轮性价比最高）
"DATA_SAMPLE_STRATEGY": "mixed",     # 采样策略（1轮latest + 1轮random）
```

### 时间控制

```python
"TRIALS_PER_ROUND": 18,              # 每轮试验数（降低以省时）
"FINAL_REFINE_TRIALS": 25,           # 精炼阶段试验数
"PRESCREEN_TRIALS": 8,               # 预筛试验数
```

### 泛化能力增强

```python
"CROSS_VALIDATION_ENABLED": True,    # 交叉验证
"ENSEMBLE_WEIGHTS": True,            # 权重集成
"ENSEMBLE_METHOD": "performance",    # 按性能加权
```

## 采样策略说明

| 策略 | 说明 | 适用场景 |
|------|------|----------|
| `"latest"` | 固定使用最新 300K bars | 单轮模式，重视近期数据 |
| `"random"` | 所有轮都随机采样 | 追求最大泛化，时间充裕 |
| `"mixed"` | 第1轮latest，其余random | **推荐**：兼顾实盘相关性与泛化 |

## 省时与增强建议

### 省时方案（时间紧张）

```python
"EVOLUTION_ROUNDS": 1,               # 退回单轮
"QUICK_PRESCREEN_ENABLED": False,    # 跳过预筛
# → 总时间: ~9分钟 (等同单轮)
```

### 增强方案（追求最佳泛化）

```python
"EVOLUTION_ROUNDS": 3,               # 3轮覆盖更多市况
"TRIALS_PER_ROUND": 20,              # 每轮更充分探索
"FINAL_REFINE_TRIALS": 30,           # 更精细优化
# → 总时间: ~17分钟 (过拟合风险最低)
```

## 预期收益

### 泛化能力提升

- ✅ **防止时间段过拟合**：不同市况都测试
- ✅ **提高实盘稳定性**：权重更鲁棒
- ✅ **降低黑天鹅风险**：交叉验证筛掉偶然性好结果

### 实验数据（预期）

| 指标 | 单轮模式 | 多轮模式 |
|------|----------|----------|
| 训练集 Sharpe | 1.2 | 1.0 ⬇️ (正常，更保守) |
| 留出集 Sharpe | 0.8 | 0.9 ⬆️ (泛化提升) |
| 实盘3个月 Sharpe | 0.5 | 0.7 ⬆️ (更稳定) |
| 最大回撤 | 25% | 20% ⬇️ (风控更好) |

## 市场状态监控（可选）

如果启用 `REGIME_TRACKING_ENABLED`，系统会记录每轮的市场特征：

```python
{
  "round_1": {
    "trend": "bullish",        # 上涨趋势
    "volatility": "high",      # 高波动
    "volume": "normal"         # 正常成交量
  },
  "round_2": {
    "trend": "ranging",        # 震荡市
    "volatility": "low",
    "volume": "low"
  }
}
```

**用途**：
- 判断训练数据是否覆盖了多种市况
- 识别某个市况下特别优秀的权重
- 为未来的市场状态自适应做准备

## 总结

多轮随机验证以 **+48% 时间成本** 换取：
1. 更强的泛化能力
2. 更低的过拟合风险
3. 更稳定的实盘表现

**推荐使用当前默认配置（2轮+预筛），性价比最优。**
