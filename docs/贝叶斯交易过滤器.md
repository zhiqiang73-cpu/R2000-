# 贝叶斯交易过滤器 - 使用说明

## 功能概述

贝叶斯交易过滤器使用 **Thompson Sampling（汤普森采样）** 算法，让系统从实盘交易中持续学习，动态调整每个原型在不同市场状态下的可信度。

### 核心思想

1. **历史回测数据作为先验**：每个原型的历史胜率作为初始假设
2. **实盘交易更新后验**：每完成一笔交易，立即更新该原型的可信度
3. **Thompson Sampling 决策**：自动平衡"探索"（试探不确定的原型）和"利用"（重用赚钱的原型）
4. **时间衰减**：远期数据权重降低，适应市场变化

### 数学原理

每个 **原型 × 市场状态** 组合维护一个 **Beta(α, β) 分布**：

```
α = 累计赢的次数 + 先验
β = 累计亏的次数 + 先验

预测胜率 = α / (α + β)
```

- **Thompson Sampling**：每次信号到来时，从 Beta(α, β) 采样一个胜率值
  - 如果采样值 >= 阈值（默认 50%）→ 允许交易
  - 如果采样值 < 阈值 → 拒绝交易

- **特性**：
  - 赢得多的原型 → α 大 → 采样值经常高 → 频繁被选中
  - 输得多的原型 → β 大 → 采样值经常低 → 自动淘汰
  - 数据少的原型 → 方差大 → 偶尔给它试试的机会

---

## 配置参数

在 `config.py` 的 `PAPER_TRADING_CONFIG` 中：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `BAYESIAN_ENABLED` | `True` | 是否启用贝叶斯过滤器 |
| `BAYESIAN_PRIOR_STRENGTH` | `10.0` | 先验强度（历史数据相当于多少笔实盘交易） |
| `BAYESIAN_MIN_WIN_RATE` | `0.50` | 最低胜率阈值（低于此值拒绝交易） |
| `BAYESIAN_THOMPSON_SAMPLING` | `True` | 是否使用 Thompson Sampling（推荐） |
| `BAYESIAN_DECAY_ENABLED` | `True` | 是否启用时间衰减（适应市场变化） |
| `BAYESIAN_DECAY_HOURS` | `24.0` | 衰减间隔（小时） |
| `BAYESIAN_DECAY_FACTOR` | `0.95` | 衰减因子（0-1，越小遗忘越快） |
| `BAYESIAN_STATE_FILE` | `"data/bayesian_state.json"` | 持久化文件路径 |

### 参数调整建议

- **先验强度**：
  - 10.0（默认）= 历史回测数据权重适中
  - 越大 = 越相信历史，学习速度慢
  - 越小 = 更快适应实盘，但容易被噪声干扰

- **最低胜率阈值**：
  - 0.50（默认）= 只做预测胜率 >= 50% 的信号
  - 提高到 0.55 = 更保守，只做高胜率信号
  - 降低到 0.48 = 更激进，给更多信号机会

- **衰减参数**：
  - 每 24 小时 × 0.95 = 缓慢遗忘旧数据
  - 调大 DECAY_FACTOR → 记忆更长久
  - 调小 → 更快适应新市场环境

---

## 工作流程

### 1. 初始化阶段（引擎启动时）

```
引擎启动 → 加载原型库 → 用历史胜率初始化 Beta(α, β)
```

示例输出：
```
[BayesianFilter] 初始化先验: proto_LONG_3_强空头 | 胜率=65.0% | 样本=50 | Beta(α=32.5, β=17.5)
[LiveEngine] 贝叶斯先验初始化完成: 83 个原型×市场状态组合
```

### 2. 交易决策阶段

```
信号到来
  ↓
原型匹配（相似度 > 阈值）
  ↓
指标门控（MACD + KDJ）
  ↓
【贝叶斯门控】← 新增
  - 从 Beta(α, β) 采样
  - 采样值 >= 50% → 通过
  - 采样值 < 50% → 拒绝
  ↓
挂限价单
```

示例输出（通过）：
```
[LiveEngine] ✅ 贝叶斯通过: proto_SHORT_12 | Thompson采样=0.63, 通过
```

示例输出（拒绝）：
```
[LiveEngine] ⛔ 贝叶斯拒绝: proto_LONG_5 | Thompson采样=0.41, 拒绝(< 50%)
```

### 3. 交易结束阶段

```
平仓（止盈/止损/信号）
  ↓
【更新 Beta 分布】← 新增
  - 赢了 → α += 1
  - 亏了 → β += 1
  ↓
自动保存到 JSON
```

示例输出：
```
[BayesianFilter] 更新: proto_SHORT_12_强空头 | 赢 +2.35% | 胜率 63.0% → 64.5% | Beta(α=33.5, β=18.5) | 实盘1笔
```

---

## 持久化

所有 Beta 分布参数自动保存到 `data/bayesian_state.json`：

```json
{
  "distributions": {
    "proto_SHORT_12_强空头": {
      "alpha": 33.5,
      "beta": 18.5,
      "trade_count": 1,
      "last_update_time": 1707836400.0
    },
    ...
  }
}
```

- **重启不丢失**：引擎重启后自动加载，继续学习
- **手动清零**：删除 `bayesian_state.json` 即可重新开始

---

## 监控与调试

### 查看当前状态

贝叶斯过滤器提供统计方法（可通过调试接口调用）：

```python
stats = engine._bayesian_filter.get_stats()
# {
#   "total_signals_received": 150,
#   "total_signals_accepted": 89,
#   "total_signals_rejected": 61,
#   "accept_rate": 0.59,
#   "unique_keys": 83,
#   "total_live_trades": 12,
# }
```

### 查看表现最好的原型

```python
top = engine._bayesian_filter.get_top_performers(top_n=10)
# [
#   {"key": "proto_SHORT_12_强空头", "win_rate": 0.71, "trade_count": 7, ...},
#   {"key": "proto_LONG_3_震荡偏多", "win_rate": 0.65, "trade_count": 5, ...},
#   ...
# ]
```

### 日志关键信息

启用后，日志会显示：

- `[BayesianFilter] 初始化先验` - 引擎启动时
- `✅ 贝叶斯通过` - 信号被接受
- `⛔ 贝叶斯拒绝` - 信号被拒绝
- `[BayesianFilter] 更新` - 每笔交易结束后
- `[BayesianFilter] 执行时间衰减` - 每 24 小时一次

---

## 与反手单的配合

贝叶斯过滤器和反手单逻辑互补：

| 机制 | 作用 | 时机 |
|------|------|------|
| **贝叶斯过滤** | 主动拒绝低胜率信号 | 入场前 |
| **反手单** | 止损后自动反方向 | 止损时 |
| **同向封锁** | 禁止重复同向入场 | 止损后 300 秒内 |

三者协同工作，形成完整的风控体系。

---

## 禁用贝叶斯过滤器

如果想暂时关闭，在 `config.py` 中：

```python
"BAYESIAN_ENABLED": False,
```

系统会退回到纯原型匹配 + 指标门控模式。

---

## 注意事项

1. **冷启动期**：每个原型至少需要 5-10 笔实盘交易才能形成可靠的后验，初期决策依赖历史先验

2. **脏数据影响**：如果用 `hold_bars=0` 的脏数据初始化，会得到错误的先验。已在实现中清空了旧数据，只用修复后的干净交易

3. **原型数量**：原型越多，每个原型分到的交易越少，学习速度越慢。建议使用 Walk-Forward 验证后的优质原型子集

4. **市场变化**：时间衰减机制能适应变化，但如果市场突然剧变，可考虑手动清零 `bayesian_state.json` 重新学习

---

## 凯利公式动态仓位管理

系统已实现凯利公式动态仓位，根据贝叶斯预测的**胜率**和**盈亏比**自动调整每笔交易的仓位大小。

### 核心公式

**完整凯利公式**：

```
f* = p - (1-p) / b

其中：
p = 胜率（贝叶斯预测）
b = 盈亏比（平均赢利 / 平均亏损）
f* = 最优仓位比例
```

**实战使用分数凯利**：

```
实际仓位 = f* × kelly_fraction

kelly_fraction = 0.25（四分之一凯利，推荐）
```

### 为什么用分数凯利？

- **完整凯利（1.0）**：理论最优，但波动过大，心理难承受
- **半凯利（0.5）**：波动适中，长期收益接近最优
- **四分之一凯利（0.25）**：**推荐值**，波动小，防止过度激进

### 配置参数

在 `config.py` 的 `PAPER_TRADING_CONFIG` 中：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `KELLY_ENABLED` | `True` | 是否启用凯利动态仓位 |
| `KELLY_FRACTION` | `0.25` | 凯利分数（0.25 = 四分之一凯利） |
| `KELLY_MAX_POSITION` | `0.5` | 仓位上限（50% 本金） |
| `KELLY_MIN_POSITION` | `0.05` | 仓位下限（5% 本金，样本不足时保守试探） |
| `KELLY_MIN_SAMPLES` | `5` | 最少样本数（少于此值用最小仓位） |

### 实战示例

假设：
- 某原型预测胜率 p = 60%
- 盈亏比 b = 2.0（平均赢 2%，平均亏 1%）
- 凯利分数 = 0.25

计算：

```python
# 完整凯利
f_full = 0.6 - (1-0.6) / 2.0 = 0.6 - 0.2 = 0.4 (40%)

# 四分之一凯利
f_actual = 0.4 × 0.25 = 0.1 (10%)

# 结果：用 10% 本金开仓
```

### 工作流程

1. **贝叶斯门控通过后**，系统调用 `calculate_kelly_fraction()`
2. **样本充足（≥5笔）**：使用凯利公式计算最优仓位
3. **样本不足（<5笔）**：使用最小仓位（5%）保守试探
4. **凯利值≤0**：说明期望收益为负，**直接拒绝交易**
5. **仓位限制**：最终仓位在 [5%, 50%] 之间

### 日志示例

```
[LiveEngine] ✅ 贝叶斯通过: proto_LONG_3 | 预测胜率=58.2%, 通过
[LiveEngine] 📊 凯利仓位: 12.3% | 凯利=0.49(p=58.2%, b=2.1) | 25%凯利=12.3% | 最终仓位=12.3%
[BinanceTrader] 放置限价开仓单: BUY 0.003 @ 95123.50 (GTC挂单, 仓位=12.3%)
```

### 动态调整效果

| 原型表现 | 胜率 | 盈亏比 | 完整凯利 | 25%凯利 | 实际仓位 |
|---------|------|--------|---------|---------|---------|
| 🌟 金牌原型 | 65% | 2.5 | 51% | 12.8% | 12.8% |
| ✅ 优秀原型 | 58% | 2.0 | 38% | 9.5% | 9.5% |
| ⚖️ 及格原型 | 52% | 1.8 | 26% | 6.5% | 6.5% |
| ⚠️ 新原型 | - | - | - | - | 5.0%（试探） |
| ❌ 亏损原型 | 45% | 1.5 | -7% | - | 拒绝 |

**效果**：
- **赚钱的原型** → 自动加大仓位
- **亏钱的原型** → 自动减小仓位或拒绝
- **样本不足** → 小仓位试探，积累数据

### 数学直觉

**为什么凯利公式有效？**

假设你有 1000 USDT，每次交易：
- 胜率 60%，赢 +20 USDT（2%）
- 输率 40%，亏 -10 USDT（1%）
- 盈亏比 = 2.0

**期望收益**：`0.6 × 20 - 0.4 × 10 = 12 - 4 = +8 USDT`（每笔）

**凯利公式告诉你**：
- 如果每次用 40% 本金（完整凯利），长期增长率**最大化**
- 但波动大（可能单次亏 -40）
- 用 10% 本金（25%凯利），长期增长率接近最优，但波动小很多

**关键洞见**：凯利公式不是最大化单笔收益，而是最大化**复利增长率**。

### 与贝叶斯协同

```
贝叶斯过滤器 → 预测胜率和盈亏比 → 凯利公式计算仓位 → 动态下单
     ↓                    ↓                   ↓
   拒绝低胜率         持续更新学习         自动调整大小
```

1. **贝叶斯**：决定"要不要做"（门控）
2. **凯利**：决定"做多大"（仓位）

### 禁用凯利公式

如果想使用固定仓位，在 `config.py` 中：

```python
"KELLY_ENABLED": False,
```

系统会退回到固定 50% 本金开仓（由 `position_size_pct` 控制）。

---

## 监控和调试

### 查看凯利计算详情

系统日志会显示每次凯利计算：

```python
[LiveEngine] 📊 凯利仓位: 12.3% | 凯利=0.49(p=58.2%, b=2.1) | 25%凯利=12.3% | 最终仓位=12.3%
```

解读：
- `凯利=0.49`：完整凯利值 49%
- `p=58.2%`：预测胜率
- `b=2.1`：盈亏比（平均赢 2.1 倍平均亏）
- `25%凯利=12.3%`：分数凯利（0.49 × 0.25）
- `最终仓位=12.3%`：实际使用的仓位

### 持久化数据

凯利所需的盈亏比数据保存在 `data/bayesian_state.json` 中：

```json
{
  "distributions": {
    "proto_LONG_3_强多头": {
      "alpha": 15.2,
      "beta": 8.7,
      "total_win_profit": 34.5,
      "total_loss_amount": 12.3,
      "win_count_real": 12,
      "loss_count_real": 6,
      "trade_count": 18
    }
  }
}
```

### 调参建议

| 场景 | Kelly Fraction | 说明 |
|------|----------------|------|
| **保守型** | 0.125 (1/8) | 波动极小，适合新手或资金安全优先 |
| **推荐型** | 0.25 (1/4) | **默认值**，平衡收益和波动 |
| **激进型** | 0.5 (1/2) | 波动较大，适合风险承受能力强的用户 |
| **理论最优** | 1.0 | **不推荐**，波动过大，心理难承受 |

---

## 注意事项

1. **冷启动期**：凯利公式依赖盈亏比数据，每个原型至少需要 5 笔交易才能计算可靠的盈亏比

2. **盈亏比估算**：初始先验使用历史回测的 `avg_profit_pct` 粗略估算（假设赢利交易平均赢 2×avg_profit，亏损交易平均亏 1%）

3. **极端情况保护**：
   - 凯利值 ≤ 0 → 拒绝交易
   - 样本不足 → 最小仓位试探
   - 上下限保护 → [5%, 50%]

4. **反手单仓位**：反手单使用默认仓位（不走凯利公式），因为反手单没有原型指纹，无法查询历史数据

---

## 总结

凯利公式 + 贝叶斯过滤器 = **自适应交易系统**

- **贝叶斯**：让系统知道哪些信号靠谱
- **凯利**：让系统知道每个信号该押多大注
- **结果**：自动优化资金配置，最大化长期复利增长

这是量化交易的**核心武器**，比固定仓位智能得多。
