# 系统平仓与收紧止损原因一览

**当前策略：仅保留分段止盈与分段止损（5%、10%）。**

以下“隐蔽”平仓/收紧逻辑已全部移除：开仓硬止盈止损线、保护期紧急止损、保护期市场冲突收紧、市场反转、位置翻转、动量衰减离场与收紧、脱轨平仓、警戒/危险区收紧止损。交易所端不再挂 TP/SL 保护单。

---

## 一、当前会触发平仓/减仓的逻辑（仅此两类）

### 分段止盈（盈利）

- **位置**：`live_trading_engine._check_staged_partial_tp()`
- **逻辑**：峰值利润 ≥ 5% 减仓 30%，≥ 10% 再减 30%。
- **配置**：`STAGED_TP_1_PCT`(5)、`STAGED_TP_2_PCT`(10)、`STAGED_TP_RATIO_1`(0.3) 等。

### 分段止损（亏损）

- **位置**：`live_trading_engine._check_staged_partial_sl()`
- **逻辑**：亏损 ≥ 5% 减仓 30%，≥ 10% 再减 30%。
- **配置**：`STAGED_SL_1_PCT`(5)、`STAGED_SL_2_PCT`(10)、`STAGED_SL_RATIO_1`(0.3) 等。

### 最大持仓时间（保留）

- **位置**：`_process_holding()`
- **逻辑**：持仓 K 线数 ≥ `MAX_HOLD_BARS`（默认 240）→ 强制全平。
- **配置**：`MAX_HOLD_BARS`。

---

## 二、已移除的平仓/收紧逻辑

| 原编号 | 说明 | 状态 |
|--------|------|------|
| 1 | 开仓时设的止损/止盈线（每 tick 检查，触及即全平） | 已移除 |
| 2 | 保护期紧急止损（前 3 根 K 线亏损超 1.5% 全平） | 已移除 |
| 3 | 保护期市场冲突（前 3 根收紧止损到 entry±0.5%） | 已移除 |
| 4 | 市场反转（3 票通过全平） | 已移除 |
| 5 | 位置翻转（区间顶/底平仓+反手） | 已移除 |
| 6 | 动量衰减离场 + 动量衰减收紧止损 | 已移除 |
| 8 | 脱轨（相似度 < 0.3 全平） | 已移除 |
| 10/11 | 警戒区/危险区收紧止损到保本或成本±0.1% | 已移除 |
| 交易所 TP/SL | 开仓后在交易所挂 STOP_MARKET/TAKE_PROFIT_MARKET | 已关闭（不挂单） |

---

## 三、配置速查（分段与最大持仓）

| 配置项 | 默认值 | 作用 |
|--------|--------|------|
| `STAGED_TP_1_PCT` | 5.0 | 分段止盈第 1 档：峰值 ≥ 5% 减仓 |
| `STAGED_TP_2_PCT` | 10.0 | 分段止盈第 2 档：峰值 ≥ 10% 再减仓 |
| `STAGED_SL_1_PCT` | 5.0 | 分段止损第 1 档：亏损 ≥ 5% 减仓 |
| `STAGED_SL_2_PCT` | 10.0 | 分段止损第 2 档：亏损 ≥ 10% 再减仓 |
| `STAGED_TP_RATIO_1` / `STAGED_SL_RATIO_1` | 0.30 | 每档减仓比例 30% |
| `MAX_HOLD_BARS` | 240 | 超过此根 K 线强制全平 |
